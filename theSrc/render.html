<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <script src="external/lodash.min.js"></script>
    <script src="external/jquery.min.js"></script>
    <script src="external/d3.min.js"></script>
    <script src="external/d3-grid.js"></script>

    <a href="/" class="prev-link" style="display:none">Prev</a>
    <a href="/">Back to Examples</a>
    <a href="/" class="next-link" style="display:none">Next</a>
    <h2 class="name" style="font-family:verdana"></h2>

    <div class="scenario" style="font-weight:600;font-family:verdana;padding-left:20px;"></div>

    <h3 style="font-family:verdana">Settings:</h2>
    <div class="settings-container">
      <div style="padding-left:20px">Percentage: <span class="percentage"></span></div>
      <div style="padding-left:20px">Width: <span class="width"></span></div>
      <div style="padding-left:20px">Height: <span class="height"></span></div>
      <pre style="padding-left:20px" class="settings"></pre>
    </div>

    <div class="content-window" style="padding-top:50px"></div>

    <div class="resize-button" style="padding-top:50px">Resize</div>

    <!-- NB This script should be defined before rhtmlPictographs.js is loaded-->
    <script>
      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        console.log('Query variable %s not found', variable);
      }

      myWidgetDefinition = null;
      myWidgetInstance = null

      // This is a stub that will capture the widget definition,
      // so that we can use it once the page finishes loading
      HTMLWidgets = {
        widget: function(widgetDefinition) {
          console.log("widget create called!");
          myWidgetDefinition = widgetDefinition;
        }
      };

      $(document).ready( function() {
        console.log("Document ready. Fetching scenarios");

        $('.resize-button').bind('click', function(event) {
          console.log("resize click");

          container = $('.content-window')
            .css('width', 100)
            .css('height', 100)

          myWidgetDefinition.resize(container, 100, 100, myWidgetInstance);
        })

        $.ajax('./resources/data/scenarios.json').done(function (response) {
          console.log("Scenario retrieved. Instantiating captured widget");

          var featureIndex = parseInt(getQueryVariable('featureIndex'));
          var featureLength = response.features.length;
          var feature = response.features[featureIndex];

          var scenarioIndex = parseInt(getQueryVariable('scenarioIndex'));
          var scenarioLength = feature.scenarios.length;
          var scenario = feature.scenarios[scenarioIndex];

          getNext = function() {
            thereIsMoreScenarios = function () {
              return (scenarioIndex + 1 < scenarioLength);
            }

            thereIsMoreFeatures = function () {
              return (featureIndex + 1 < featureLength);
            }

            if (thereIsMoreScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex + 1
              }
            }

            else if (thereIsMoreFeatures()) {
              return {
                feature: featureIndex + 1,
                scenario: 0
              }
            }

            return null;
          }

          getPrev = function() {
            thereIsPreviousScenarios = function () {
              return (scenarioIndex > 0);
            }

            thereIsPreviousFeatures = function () {
              return (featureIndex > 0);
            }

            previousScenarioLength = function () {
              response.features[featureIndex-1].length - 1;
            }

            if (thereIsPreviousScenarios()) {
              return {
                feature: featureIndex,
                scenario: scenarioIndex - 1
              }
            }

            else if (thereIsPreviousFeatures()) {
              return {
                feature: featureIndex - 1,
                scenario: previousScenarioLength()
              }
            }

            return null;
          }

          if (getPrev()) {
            prev = getPrev();
            link = 'render.html?featureIndex=' + prev.feature + '&scenarioIndex=' + prev.scenario;
            $('.prev-link').attr('href', link).css('display', 'inline-block');          }

          if (getNext()) {
            next = getNext();
            link = 'render.html?featureIndex=' + next.feature + '&scenarioIndex=' + next.scenario;
            $('.next-link').attr('href', link).css('display', 'inline-block');
          }

          $('.name').text(scenario.name);
          $('.percentage').text(scenario.percentage);
          $('.width').text(scenario.width);
          $('.height').text(scenario.height);
          _.forEach(scenario.description, function(descriptionLine) {
            textLine = $('<p>').text(descriptionLine);
            $('.scenario').append(textLine);
          });
          $('.settings').text(JSON.stringify(scenario.settings, {}, 2));


          myWidgetInstance = myWidgetDefinition.initialize($('.content-window'),scenario.width,scenario.height);
          params = {
            percentage: scenario.percentage,
            settingsJsonString: scenario.settings
          };

          container = $('.content-window')
            .css('width', scenario.width)
            .css('height', scenario.height)

          myWidgetDefinition.renderValue(container, params, myWidgetInstance);

        }).fail( function(error) {
          console.error("Download of ./resources/data/scenarios.json failed. Probably invalid JSON.");
          console.error(error);
          $('body').append($('<div>').text("Failure to download/parse ./resources/data/scenarios.json (probably invalid JSON). See dev tools console for error logging."));
        });
      });
    </script>

    <script src="scripts/rhtmlPictographs.js"></script>
  </body>
</html>
