<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="styles/main.css">
  </head>
  <body>
    <script src="external/lodash.min.js"></script>
    <script src="external/jquery.min.js"></script>
    <script src="external/d3.min.js"></script>
    <script src="external/d3-grid.js"></script>

    <a href="/" class="prev-link" style="display:none">Prev</a>
    <a href="/">Back to Examples</a>
    <a href="/" class="next-link" style="display:none">Next</a>
    <h2 class="name" style="font-family:verdana"></h2>

    <div class="scenario" style="font-weight:600;font-family:verdana;padding-left:20px;"></div>

    <h3 style="font-family:verdana">Settings:</h2>
    <div class="settings-container">
      <div style="padding-left:20px">Percentage: <span class="percentage"></span></div>
      <div style="padding-left:20px">Width: <span class="width"></span></div>
      <div style="padding-left:20px">Height: <span class="height"></span></div>
      <pre style="padding-left:20px" class="settings"></pre>
    </div>

    <div class="content-window" style="padding-top:50px"></div>

    <!-- NB This script should be defined before croppedimage.js-->
    <script>
      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        console.log('Query variable %s not found', variable);
      }

      myWidgetDefinition = null;

      // This is a stub that will capture the widget definition,
      // so that we can use it once the page finishes loading
      HTMLWidgets = {
        widget: function(widgetDefinition) {
          console.log("widget create called!");
          myWidgetDefinition = widgetDefinition;
        }
      };

      $(document).ready( function() {
        console.log("Document ready. Fetching scenarios");


        $.ajax('./test/scenarios.json').done(function (response) {
          console.log("Scenario retrieved. Instantiating captured widget");

          scenarioIndex = getQueryVariable('index');
          if (scenarioIndex > 0) {
            $('.prev-link').attr('href', 'render.html?index=' + (parseInt(scenarioIndex) - 1))
              .css('display', 'inline-block');
          }
          if (scenarioIndex < response.scenarios.length - 1) {
            $('.next-link').attr('href', 'render.html?index=' + (parseInt(scenarioIndex) + 1))
              .css('display', 'inline-block');
          }

          scenario = response.scenarios[scenarioIndex];

          $('.name').text(scenario.name);
          $('.percentage').text(scenario.percentage);
          $('.width').text(scenario.width);
          $('.height').text(scenario.height);
          _.forEach(scenario.description, function(descriptionLine) {
            textLine = $('<p>').text(descriptionLine);
            $('.scenario').append(textLine);
          });
          $('.settings').text(JSON.stringify(scenario.settings, {}, 2));


          widgetInstance = myWidgetDefinition.initialize($('.content-window'),scenario.width,scenario.height);
          params = {
            percentage: scenario.percentage,
            settingsJsonString: scenario.settings
          };
          myWidgetDefinition.renderValue($('.content-window'), params, widgetInstance);

        }).fail( function(error) {
          console.error("Download of ./test/scenarios.json failed. Probably invalid JSON.");
          console.error(error);
          $('body').append($('<div>').text("Failure to download/parse ./test/scenarios.json (probably invalid JSON). See dev tools console for error logging."));
        });
      });
    </script>

    <script src="scripts/CroppedImage.js"></script>
  </body>
</html>
